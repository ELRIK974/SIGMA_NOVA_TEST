<!-- Fonctions pour la page Gestion des Emprunts -->
<script>
// Variable globale pour stocker l'ID de l'emprunt à supprimer
let empruntToDelete = null;

// Fonction d'initialisation pour la page Emprunts
function initializeEmpruntsPage() {
  console.log("Initialisation de la page Emprunts");
  
  // Charger les emprunts
  loadEmpruntsData();
  
  // Configurer les gestionnaires d'événements
  setupEmpruntsEventHandlers();
}

// Charger les données des emprunts
function loadEmpruntsData() {
  showSpinner();
  
  google.script.run
    .withSuccessHandler(function(data) {
      hideSpinner();
      console.log("Données reçues:", data);
      
      if (data && data.emprunts) {
        // Remplir le tableau avec les emprunts
        fillEmpruntsTable(data.emprunts);
      } else {
        console.error("Format de données incorrect:", data);
        document.querySelector('#empruntsTable tbody').innerHTML = 
          '<tr><td colspan="6" class="text-center">Erreur: données incorrectes</td></tr>';
      }
    })
    .withFailureHandler(function(error) {
      hideSpinner();
      console.error("Erreur lors du chargement des emprunts:", error);
      document.querySelector('#empruntsTable tbody').innerHTML = 
        '<tr><td colspan="6" class="text-center">Erreur lors du chargement des données</td></tr>';
    })
    .getEmpruntsPageData(1, 10, 'Tous');
}

// Configurer les gestionnaires d'événements
function setupEmpruntsEventHandlers() {
  // Ajouter le gestionnaire d'événement pour le bouton de suppression
  const confirmDeleteBtn = document.getElementById('confirmDeleteEmprunt');
  if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', function() {
      if (empruntToDelete) {
        deleteEmprunt(empruntToDelete);
      }
    });
  }
  
  // Ajouter le gestionnaire d'événement pour le bouton Nouvel emprunt
  const btnNouvelEmprunt = document.getElementById('btnNouvelEmprunt');
  if (btnNouvelEmprunt) {
    btnNouvelEmprunt.addEventListener('click', function() {
      alert("La création d'emprunts sera implémentée dans la prochaine étape.");
    });
  }
}

// Remplir le tableau des emprunts
function fillEmpruntsTable(emprunts) {
  const tbody = document.querySelector('#empruntsTable tbody');
  if (!tbody) {
    console.error("Élément tbody non trouvé");
    return;
  }
  
  tbody.innerHTML = '';
  
  if (!emprunts || emprunts.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="6" class="text-center">Aucun emprunt trouvé</td>';
    tbody.appendChild(row);
    return;
  }
  
  emprunts.forEach(emprunt => {
    const row = document.createElement('tr');
    
    // Ajouter une classe selon le statut
    if (emprunt.Statut === "Pas prêt") {
      row.classList.add('table-warning');
    } else if (emprunt.Statut === "Parti") {
      row.classList.add('table-info');
    } else if (emprunt.Statut === "Revenu") {
      row.classList.add('table-success');
    }
    
    row.innerHTML = `
      <td>${emprunt.ID || ''}</td>
      <td>${emprunt["Nom Manipulation"] || ''}</td>
      <td>${emprunt["Date départ"] || ''} - ${emprunt["Date retour"] || ''}</td>
      <td><span class="badge ${getStatusBadgeClass(emprunt.Statut)}">${emprunt.Statut || ''}</span></td>
      <td>${emprunt.Emprunteur || ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1 btn-edit-emprunt" data-id="${emprunt.ID}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger btn-delete-emprunt" data-id="${emprunt.ID}">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // Ajouter les gestionnaires d'événements pour les boutons d'action
  document.querySelectorAll('.btn-edit-emprunt').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      alert(`La modification d'emprunt sera implémentée dans la prochaine étape (ID: ${id}).`);
    });
  });
  
  document.querySelectorAll('.btn-delete-emprunt').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      confirmDeleteEmprunt(id);
    });
  });
}

// Obtenir la classe CSS pour le badge de statut
function getStatusBadgeClass(status) {
  switch(status) {
    case 'Pas prêt': return 'bg-warning text-dark';
    case 'Prêt': return 'bg-primary';
    case 'Parti': return 'bg-info';
    case 'Revenu': return 'bg-success';
    case 'Inventorié': return 'bg-secondary';
    default: return 'bg-secondary';
  }
}

// Confirmer la suppression d'un emprunt
function confirmDeleteEmprunt(id) {
  empruntToDelete = id;
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  modal.show();
}

// Supprimer un emprunt
function deleteEmprunt(id) {
  showSpinner();
  
  google.script.run
    .withSuccessHandler(function(success) {
      hideSpinner();
      
      // Fermer le modal de confirmation
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
      if (deleteModal) {
        deleteModal.hide();
      }
      
      // Réinitialiser l'ID de l'emprunt à supprimer
      empruntToDelete = null;
      
      if (success) {
        // Recharger les données
        loadEmpruntsData();
      } else {
        showErrorMessage("Erreur lors de la suppression de l'emprunt");
      }
    })
    .withFailureHandler(function(error) {
      hideSpinner();
      console.error("Erreur lors de la suppression de l'emprunt:", error);
      showErrorMessage("Erreur lors de la suppression de l'emprunt");
    })
    .deleteEmpruntFromUI(id);
}
</script>
