<!-- Fonctions pour la page Gestion des Emprunts -->
<script>
// Variables globales pour la page Emprunts
window.empruntsCurrentPage = 1;
window.empruntsPageSize = 10;
window.empruntsCurrentFilter = 'Tous';
window.empruntsCurrentSearch = '';

// Initialisation de la page Emprunts
// Compteur pour limiter les tentatives de réinitialisation
let empruntsInitAttempts = 0;

window.initializeEmpruntsPage = function() {
  console.log('Initialisation de la page Emprunts - DÉBUT');
  empruntsInitAttempts++;
  
  // Limite de sécurité pour éviter les boucles infinies
  if (empruntsInitAttempts > 3) {
    console.error('Trop de tentatives d\'initialisation de la page Emprunts');
    showErrorMessage('Erreur d\'initialisation. Veuillez rafraîchir la page.');
    return;
  }
  
  try {
    // Vérifier si la page est correctement chargée
    const empruntsPage = document.getElementById('empruntsPage');
    if (!empruntsPage) {
      console.error('Le conteneur #empruntsPage n\'est pas disponible');
      return; // Sortir sans rappel
    }
    
    // Chargement initial des données
    console.log('Appel de loadEmpruntsData()');
    window.loadEmpruntsData();
    
    // Configuration des gestionnaires d'événements
    console.log('Appel de setupEmpruntsEventHandlers()');
    window.setupEmpruntsEventHandlers();
    
    console.log('Initialisation de la page Emprunts - FIN');
  } catch (error) {
    console.error('ERREUR dans initializeEmpruntsPage:', error);
    showErrorMessage('Erreur d\'initialisation: ' + error.message);
  }
};

// Fonction pour charger les données des emprunts
window.loadEmpruntsData = function() {
  window.showSpinner();
  
  google.script.run
    .withSuccessHandler(function(data) {
      window.hideSpinner();
      console.log('Données reçues:', data);
      
      if (data && data.emprunts) {
        window.fillEmpruntsTable(data.emprunts);
        window.updateEmpruntsPagination(data.pagination);
      } else {
        console.error('Format de données incorrect:', data);
        // Utiliser la notification au lieu d'une alerte
        showErrorMessage('Format de données incorrect reçu du serveur. Essayez de réinitialiser l\'application.');
        
        // Ajouter un bouton de réinitialisation
        const mainContent = document.querySelector('#empruntsPage');
        if (mainContent) {
          const resetButton = document.createElement('button');
          resetButton.className = 'btn btn-warning mt-3';
          resetButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Initialiser les données';
          resetButton.onclick = function() {
            window.showSpinner();
            google.script.run
              .withSuccessHandler(function(result) {
                window.hideSpinner();
                if (result.success) {
                  showSuccessMessage("Initialisation réussie. Rechargement des données...");
                  setTimeout(window.loadEmpruntsData, 1000);
                } else {
                  showErrorMessage("Échec de l'initialisation: " + result.message);
                }
              })
              .withFailureHandler(function(error) {
                window.hideSpinner();
                showErrorMessage("Erreur lors de l'initialisation: " + error);
              })
              .initializeApplication();
          };
          
          // Ajouter au début du contenu
          mainContent.insertBefore(resetButton, mainContent.firstChild);
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur lors du chargement des données:', error);
      window.hideSpinner();
      showErrorMessage('Erreur lors du chargement des données: ' + error);
    })
    .getEmpruntsPageData(window.empruntsCurrentPage, window.empruntsPageSize, window.empruntsCurrentFilter, window.empruntsCurrentSearch);
};

// Configuration des gestionnaires d'événements pour la page Emprunts
// Remplacer la fonction dans empruntsUIFunctions.html
window.setupEmpruntsEventHandlers = function() {
  // Événement pour la recherche
  const searchInput = document.getElementById('searchEmprunt');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      window.empruntsCurrentSearch = this.value;
      window.empruntsCurrentPage = 1; // Retourner à la première page lors d'une recherche
      window.loadEmpruntsData();
    });
  }
  
  // Ajouter le gestionnaire pour le bouton de diagnostic
  const btnDiagnostic = document.getElementById('btnDiagnostic');
  if (btnDiagnostic) {
    btnDiagnostic.addEventListener('click', function() {
      window.showSpinner();
      
      google.script.run
        .withSuccessHandler(function(result) {
          window.hideSpinner();
          console.log("Diagnostic du système:", result);
          
          // Afficher les résultats dans un modal
          const modal = document.createElement('div');
          modal.className = 'modal fade';
          modal.id = 'diagnosticModal';
          modal.setAttribute('tabindex', '-1');
          modal.innerHTML = `
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Diagnostic du système</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                  <pre style="max-height: 400px; overflow: auto;">${JSON.stringify(result, null, 2)}</pre>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="btnFixSystem">
                    <i class="fas fa-wrench me-1"></i> Réparer le système
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          const modalInstance = new bootstrap.Modal(modal);
          modalInstance.show();
          
          // Ajouter le gestionnaire d'événements pour le bouton de réparation
          modal.querySelector('#btnFixSystem').addEventListener('click', function() {
            window.showSpinner();
            modalInstance.hide();
            
            google.script.run
              .withSuccessHandler(function(fixResult) {
                window.hideSpinner();
                if (fixResult && fixResult.success) {
                  showSuccessMessage("Système réparé avec succès. Rechargement des données...");
                  setTimeout(window.loadEmpruntsData, 1000);
                } else {
                  showErrorMessage("Échec de la réparation: " + (fixResult ? fixResult.message : "Erreur inconnue"));
                }
              })
              .withFailureHandler(function(error) {
                window.hideSpinner();
                showErrorMessage("Erreur lors de la réparation: " + error);
              })
              .initializeApplication();
          });
          
          // Supprimer le modal du DOM après sa fermeture
          modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
          });
        })
        .withFailureHandler(function(error) {
          window.hideSpinner();
          showErrorMessage("Erreur lors du diagnostic: " + error);
        })
        .checkSystemStatus();
    });
  }
  
  // Événement pour le filtre de statut
  const filterDropdown = document.getElementById('empruntFilterDropdown');
  if (filterDropdown) {
    filterDropdown.addEventListener('click', function(e) {
      if (e.target.classList.contains('dropdown-item')) {
        e.preventDefault();
        
        // Mettre à jour le filtre actif visuellement
        document.querySelectorAll('#empruntFilterDropdown .dropdown-item').forEach(item => {
          item.classList.remove('active');
        });
        e.target.classList.add('active');
        
        // Appliquer le filtre
        window.empruntsCurrentFilter = e.target.getAttribute('data-filter');
        window.empruntsCurrentPage = 1; // Retourner à la première page lors d'un filtrage
        window.loadEmpruntsData();
      }
    });
  }
  
  // Événement pour le bouton Nouvel emprunt
  const btnNew = document.getElementById('btnNouvelEmprunt');
  if (btnNew) {
    btnNew.addEventListener('click', function() {
      window.openEmpruntForm();
    });
  }
  
  // Événement pour le bouton Enregistrer dans le formulaire
  const btnSave = document.getElementById('saveEmprunt');
  if (btnSave) {
    btnSave.addEventListener('click', function() {
      window.saveEmpruntForm();
    });
  }
};

// Remplir le tableau avec les emprunts
window.fillEmpruntsTable = function(emprunts) {
  const tbody = document.querySelector('#empruntsTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!emprunts || emprunts.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="6" class="text-center">Aucun emprunt trouvé</td>`;
    tbody.appendChild(row);
    return;
  }
  
  emprunts.forEach(emprunt => {
    const row = document.createElement('tr');
    
    // Ajouter une classe selon le statut
    if (emprunt.Statut === "Pas prêt") {
      row.classList.add('table-warning');
    } else if (emprunt.Statut === "Parti") {
      row.classList.add('table-info');
    } else if (emprunt.Statut === "Revenu") {
      row.classList.add('table-success');
    }
    
    // Formatage des dates
    let dateDepart = emprunt["Date départ"] || "";
    let dateRetour = emprunt["Date retour"] || "";
    
    row.innerHTML = `
      <td>${emprunt.ID || ""}</td>
      <td>${emprunt["Nom Manipulation"] || ""}</td>
      <td>${dateDepart} - ${dateRetour}</td>
      <td><span class="badge ${getBadgeClass(emprunt.Statut)}">${emprunt.Statut || ""}</span></td>
      <td>${emprunt.Emprunteur || ""}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1 btn-view" data-id="${emprunt.ID}">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${emprunt.ID}">
          <i class="fas fa-edit"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // Ajouter les gestionnaires d'événements pour les boutons d'action
  document.querySelectorAll('#empruntsTable .btn-view').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.getAttribute('data-id');
      window.viewEmprunt(itemId);
    });
  });
  
  document.querySelectorAll('#empruntsTable .btn-edit').forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.getAttribute('data-id');
      window.editEmprunt(itemId);
    });
  });
};

// Mettre à jour la pagination
window.updateEmpruntsPagination = function(pagination) {
  const paginationEl = document.getElementById('empruntsPagination');
  if (!paginationEl) return;
  
  paginationEl.innerHTML = '';
  
  if (!pagination) return;
  
  // Bouton Précédent
  const prevItem = document.createElement('li');
  prevItem.className = `page-item ${pagination.currentPage === 1 ? 'disabled' : ''}`;
  prevItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage - 1}">Précédent</a>`;
  paginationEl.appendChild(prevItem);
  
  // Pages numérotées
  for (let i = 1; i <= pagination.totalPages; i++) {
    const pageItem = document.createElement('li');
    pageItem.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;
    pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
    paginationEl.appendChild(pageItem);
  }
  
  // Bouton Suivant
  const nextItem = document.createElement('li');
  nextItem.className = `page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}`;
  nextItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage + 1}">Suivant</a>`;
  paginationEl.appendChild(nextItem);
  
  // Ajouter les gestionnaires d'événements pour les liens de pagination
  document.querySelectorAll('#empruntsPagination .page-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!this.parentElement.classList.contains('disabled')) {
        window.empruntsCurrentPage = parseInt(this.getAttribute('data-page'));
        window.loadEmpruntsData();
      }
    });
  });
};

// Fonction utilitaire pour obtenir la classe de badge selon le statut
window.getBadgeClass = function(status) {
  switch(status) {
    case 'Pas prêt': return 'bg-warning text-dark';
    case 'Prêt': return 'bg-primary';
    case 'Parti': return 'bg-info';
    case 'Revenu': return 'bg-success';
    case 'Inventorié': return 'bg-secondary';
    default: return 'bg-secondary';
  }
};

// Ouvrir le formulaire d'emprunt (pour création ou édition)
window.openEmpruntForm = function(empruntData = null) {
  // Réinitialiser le formulaire
  const form = document.getElementById('empruntForm');
  if (!form) return;
  
  form.reset();
  document.getElementById('empruntId').value = '';
  
  // Définir la date d'aujourd'hui comme date par défaut pour le départ
  const today = new Date();
  const todayFormatted = today.toISOString().split('T')[0]; // Format YYYY-MM-DD
  document.getElementById('empruntDateDepart').value = todayFormatted;
  
  // Définir une date par défaut pour le retour (aujourd'hui + 14 jours)
  const returnDate = new Date();
  returnDate.setDate(returnDate.getDate() + 14);
  const returnDateFormatted = returnDate.toISOString().split('T')[0];
  document.getElementById('empruntDateRetour').value = returnDateFormatted;
  
  if (empruntData) {
    // Mode édition
    document.getElementById('empruntModalLabel').textContent = 'Modifier un emprunt';
    document.getElementById('empruntId').value = empruntData.ID;
    document.getElementById('empruntNom').value = empruntData["Nom Manipulation"] || '';
    document.getElementById('empruntLieu').value = empruntData.Lieu || '';
    
    // Conversion des dates au format YYYY-MM-DD si nécessaire
    let dateDepart = empruntData["Date départ"] || '';
    if (dateDepart && dateDepart.includes('/')) {
      const parts = dateDepart.split('/');
      dateDepart = `${parts[2]}-${parts[1]}-${parts[0]}`; // Format YYYY-MM-DD
    }
    document.getElementById('empruntDateDepart').value = dateDepart || todayFormatted;
    
    let dateRetour = empruntData["Date retour"] || '';
    if (dateRetour && dateRetour.includes('/')) {
      const parts = dateRetour.split('/');
      dateRetour = `${parts[2]}-${parts[1]}-${parts[0]}`; // Format YYYY-MM-DD
    }
    document.getElementById('empruntDateRetour').value = dateRetour || returnDateFormatted;
    
    document.getElementById('empruntSecteur').value = empruntData.Secteur || '';
    document.getElementById('empruntReferent').value = empruntData.Référent || '';
    document.getElementById('empruntEmprunteur').value = empruntData.Emprunteur || '';
    document.getElementById('empruntNotes').value = empruntData.Notes || '';
  } else {
    // Mode création
    document.getElementById('empruntModalLabel').textContent = 'Nouvel emprunt';
  }
  
  // Afficher le modal
  const modal = new bootstrap.Modal(document.getElementById('empruntModal'));
  modal.show();
};

// Éditer un emprunt existant
window.editEmprunt = function(itemId) {
  window.showSpinner();
  
  google.script.run
    .withSuccessHandler(function(empruntData) {
      window.hideSpinner();
      if (empruntData) {
        window.openEmpruntForm(empruntData);
      } else {
        alert('Emprunt non trouvé');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur lors de la récupération des données de l\'emprunt:', error);
      window.hideSpinner();
      alert('Erreur lors de la récupération des données de l\'emprunt');
    })
    .getEmpruntForEdit(itemId);
};

// Visualiser les détails d'un emprunt
window.viewEmprunt = function(itemId) {
  window.showSpinner();
  
  google.script.run
    .withSuccessHandler(function(empruntData) {
      window.hideSpinner();
      if (empruntData) {
        // Pour l'instant, simplement afficher les détails dans une alerte
        alert(`Détails de l'emprunt ${empruntData.ID}:\n
Nom: ${empruntData["Nom Manipulation"]}\n
Lieu: ${empruntData.Lieu}\n
Dates: ${empruntData["Date départ"]} - ${empruntData["Date retour"]}\n
Statut: ${empruntData.Statut}\n
Emprunteur: ${empruntData.Emprunteur}`);
        
        // Note: Dans une version future, nous pourrions créer une page de détails dédiée
      } else {
        alert('Emprunt non trouvé');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur lors de la récupération des détails de l\'emprunt:', error);
      window.hideSpinner();
      alert('Erreur lors de la récupération des détails de l\'emprunt');
    })
    .getEmpruntForView(itemId);
};

// Sauvegarder les données du formulaire d'emprunt
window.saveEmpruntForm = function() {
  // Valider le formulaire
  const form = document.getElementById('empruntForm');
  if (!form) return;
  
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  // Récupérer les données du formulaire
  const empruntData = {
    ID: document.getElementById('empruntId').value,
    "Nom Manipulation": document.getElementById('empruntNom').value,
    Lieu: document.getElementById('empruntLieu').value,
    "Date départ": document.getElementById('empruntDateDepart').value, // Format YYYY-MM-DD
    "Date retour": document.getElementById('empruntDateRetour').value, // Format YYYY-MM-DD
    Secteur: document.getElementById('empruntSecteur').value,
    Référent: document.getElementById('empruntReferent').value,
    Emprunteur: document.getElementById('empruntEmprunteur').value,
    Notes: document.getElementById('empruntNotes').value
  };
  
  window.showSpinner();
  
  google.script.run
    .withSuccessHandler(function(result) {
      window.hideSpinner();
      
      if (result) {
        // Fermer le modal
        bootstrap.Modal.getInstance(document.getElementById('empruntModal')).hide();
        
        // Recharger les données
        window.loadEmpruntsData();
        
        // Afficher un message de succès
        alert('Emprunt enregistré avec succès');
      } else {
        alert('Erreur lors de l\'enregistrement de l\'emprunt');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur lors de l\'enregistrement de l\'emprunt:', error);
      window.hideSpinner();
      alert('Erreur lors de l\'enregistrement de l\'emprunt: ' + error);
    })
    .saveEmpruntFromUI(empruntData);
};
</script>
