// Variables globales pour la page Emprunts
window.empruntsCurrentPage = 1;
window.empruntsPageSize = 10;
window.empruntsCurrentFilter = 'Tous';
window.empruntsCurrentSearch = '';
window.empruntToDelete = null;

// Initialisation de la page Emprunts - Version simplifiée pour éviter les récursions
window.initializeEmpruntsPage = function() {
  console.log('Initialisation de la page Emprunts - Version simplifiée');
  
  // Ajout d'un bouton d'urgence
  const headerDiv = document.querySelector('#empruntsPage h1');
  if (headerDiv) {
    const emergencyButton = document.createElement('button');
    emergencyButton.className = 'btn btn-danger btn-sm ms-3';
    emergencyButton.innerHTML = '<i class="fas fa-ambulance me-1"></i> Réparation d\'urgence';
    emergencyButton.onclick = function() { runEmergencyRepair(); };
    headerDiv.appendChild(emergencyButton);
  }
  
  // Chargement des données
  setTimeout(function() {
    getEmergencyData();
  }, 500);
};

// Fonction d'urgence pour charger les données des emprunts
function getEmergencyData() {
  window.showSpinner();
  
  const tbody = document.querySelector('#empruntsTable tbody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Récupération des données...</td></tr>';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      window.hideSpinner();
      console.log('Données récupérées:', result);
      
      if (result && result.emprunts && result.emprunts.length > 0) {
        displayEmprunts(result.emprunts);
      } else {
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center">
            <div class="alert alert-warning">
              Aucune donnée disponible. 
              <button class="btn btn-primary btn-sm ms-2" onclick="runEmergencyRepair()">
                Réparer la base de données
              </button>
            </div>
          </td></tr>`;
        }
      }
    })
    .withFailureHandler(function(error) {
      window.hideSpinner();
      console.error('Erreur:', error);
      
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">
          <div class="alert alert-danger">
            Erreur: ${error}
            <button class="btn btn-primary btn-sm ms-2" onclick="runEmergencyRepair()">
              Réparer la base de données
            </button>
          </div>
        </td></tr>`;
      }
    })
    .listAllEmprunts();
}

// Fonction de réparation d'urgence
function runEmergencyRepair() {
  window.showSpinner();
  
  alert("Lancement de la réparation d'urgence.\nCela va réinitialiser et recréer la feuille Emprunts.");
  
  google.script.run
    .withSuccessHandler(function(result) {
      window.hideSpinner();
      console.log('Réparation terminée:', result);
      alert('Réparation terminée. Rechargement des données...');
      
      // Après réparation, attendre un peu puis recharger
      setTimeout(function() {
        getEmergencyData();
      }, 1000);
    })
    .withFailureHandler(function(error) {
      window.hideSpinner();
      console.error('Erreur de réparation:', error);
      alert('Erreur pendant la réparation: ' + error);
    })
    .forceAddTestEmprunts();
}

// Afficher les emprunts
function displayEmprunts(emprunts) {
  const tbody = document.querySelector('#empruntsTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  emprunts.forEach(emprunt => {
    const row = document.createElement('tr');
    
    // Ajouter une classe selon le statut
    if (emprunt.Statut === "Pas prêt") {
      row.classList.add('table-warning');
    } else if (emprunt.Statut === "Parti") {
      row.classList.add('table-info');
    } else if (emprunt.Statut === "Revenu") {
      row.classList.add('table-success');
    }
    
    row.innerHTML = `
      <td>${emprunt.ID || ''}</td>
      <td>${emprunt["Nom Manipulation"] || ''}</td>
      <td>${emprunt["Date départ"] || ''} - ${emprunt["Date retour"] || ''}</td>
      <td><span class="badge ${getBadgeClass(emprunt.Statut)}">${emprunt.Statut || ''}</span></td>
      <td>${emprunt.Emprunteur || ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary me-1">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Fonction pour obtenir la classe de badge selon le statut
function getBadgeClass(status) {
  switch(status) {
    case 'Pas prêt': return 'bg-warning text-dark';
    case 'Prêt': return 'bg-primary';
    case 'Parti': return 'bg-info';
    case 'Revenu': return 'bg-success';
    case 'Inventorié': return 'bg-secondary';
    default: return 'bg-secondary';
  }
}
