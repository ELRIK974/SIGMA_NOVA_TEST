<div id="empruntsPage">
  <h1 class="mb-4">
    <i class="fas fa-exchange-alt me-2"></i>
    Gestion des emprunts
  </h1>
  
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-list me-2"></i> Liste des emprunts</span>
          <button type="button" class="btn btn-success btn-sm" id="btnNouvelEmprunt">
            <i class="fas fa-plus me-1"></i> Nouvel emprunt
          </button>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" placeholder="Rechercher un emprunt..." id="searchEmprunts">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Filtrer par statut</button>
              <ul class="dropdown-menu dropdown-menu-end" id="statusFilterDropdown">
                <li><a class="dropdown-item active" href="#" data-filter="Tous">Tous</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Pas prêt">Pas prêt</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Prêt">Prêt</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Parti">Parti</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Revenu">Revenu</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Inventorié">Inventorié</a></li>
              </ul>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="empruntsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nom Manipulation</th>
                  <th>Dates (Départ - Retour)</th>
                  <th>Statut</th>
                  <th>Emprunteur</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Sera rempli dynamiquement -->
                <tr>
                  <td colspan="6" class="text-center">Chargement des données...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <nav aria-label="Pagination des emprunts">
            <ul class="pagination justify-content-center" id="empruntsPagination">
              <!-- Sera rempli dynamiquement -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Inclure le formulaire d'emprunt -->
  <?!= include('empruntForm'); ?>
</div>

<script>
  // Variables globales pour la page Emprunts
  let currentPage = 1;
  let pageSize = 10;
  let currentFilter = 'Tous';
  let currentSearch = '';
  
  // Fonction d'initialisation de la page Emprunts
  function initializeEmpruntsPage() {
    console.log('Initialisation de la page Emprunts - Étape 3');
    
    // Chargement initial des données
    loadEmpruntsData();
    
    // Configuration des gestionnaires d'événements
    setupEmpruntsEventHandlers();
  }
  
  // Fonction pour charger les données des emprunts
  function loadEmpruntsData() {
    showSpinner();
    
    google.script.run
      .withSuccessHandler(function(data) {
        hideSpinner();
        
        // Remplir le tableau avec les emprunts
        fillEmpruntsTable(data.emprunts);
        
        // Mettre à jour la pagination
        updateEmpruntsPagination(data.pagination);
      })
      .withFailureHandler(function(error) {
        console.error('Erreur lors du chargement des emprunts:', error);
        hideSpinner();
        showErrorMessage('Erreur lors du chargement des emprunts: ' + error);
      })
      .getEmpruntsPageData(currentPage, pageSize, currentFilter, currentSearch);
  }
  
  // Configuration des gestionnaires d'événements pour la page Emprunts
  function setupEmpruntsEventHandlers() {
    // Événement pour la recherche
    document.getElementById('searchEmprunts').addEventListener('input', function() {
      currentSearch = this.value;
      currentPage = 1; // Retourner à la première page lors d'une recherche
      loadEmpruntsData();
    });
    
    // Événement pour le filtre de statut
    document.getElementById('statusFilterDropdown').addEventListener('click', function(e) {
      if (e.target.classList.contains('dropdown-item')) {
        e.preventDefault();
        
        // Mettre à jour le filtre actif visuellement
        document.querySelectorAll('#statusFilterDropdown .dropdown-item').forEach(item => {
          item.classList.remove('active');
        });
        e.target.classList.add('active');
        
        // Appliquer le filtre
        currentFilter = e.target.getAttribute('data-filter');
        currentPage = 1; // Retourner à la première page lors d'un filtrage
        loadEmpruntsData();
      }
    });
    
    // Événement pour le bouton Nouvel emprunt
    document.getElementById('btnNouvelEmprunt').addEventListener('click', function() {
      openEmpruntForm();
    });
    
    // Événement pour le bouton Enregistrer dans le formulaire
    document.getElementById('saveEmprunt').addEventListener('click', function() {
      saveEmpruntForm();
    });
  }
  
  // Remplir le tableau avec les emprunts
  function fillEmpruntsTable(emprunts) {
    const tbody = document.querySelector('#empruntsTable tbody');
    tbody.innerHTML = '';
    
    if (!emprunts || emprunts.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="6" class="text-center">Aucun emprunt trouvé</td>`;
      tbody.appendChild(row);
      return;
    }
    
    emprunts.forEach(emprunt => {
      const row = document.createElement('tr');
      
      // Ajouter une classe selon le statut
      if (emprunt.Statut === "Pas prêt") {
        row.classList.add('table-warning');
      } else if (emprunt.Statut === "Parti") {
        row.classList.add('table-info');
      } else if (emprunt.Statut === "Revenu") {
        row.classList.add('table-success');
      }
      
      row.innerHTML = `
        <td>${emprunt.ID}</td>
        <td>${emprunt["Nom Manipulation"] || ''}</td>
        <td>${emprunt["Date départ"] || ''} - ${emprunt["Date retour"] || ''}</td>
        <td><span class="badge ${getBadgeClass(emprunt.Statut)}">${emprunt.Statut || ''}</span></td>
        <td>${emprunt.Emprunteur || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1 btn-view" data-id="${emprunt.ID}">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${emprunt.ID}">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Ajouter les gestionnaires d'événements pour les boutons d'action
    document.querySelectorAll('#empruntsTable .btn-edit').forEach(btn => {
      btn.addEventListener('click', function() {
        const empruntId = this.getAttribute('data-id');
        editEmprunt(empruntId);
      });
    });
    
    document.querySelectorAll('#empruntsTable .btn-view').forEach(btn => {
      btn.addEventListener('click', function() {
        const empruntId = this.getAttribute('data-id');
        viewEmprunt(empruntId);
      });
    });
  }
  
  // Mettre à jour la pagination
  function updateEmpruntsPagination(pagination) {
    const paginationEl = document.getElementById('empruntsPagination');
    paginationEl.innerHTML = '';
    
    // Bouton Précédent
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${pagination.currentPage === 1 ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage - 1}">Précédent</a>`;
    paginationEl.appendChild(prevItem);
    
    // Pages numérotées
    for (let i = 1; i <= pagination.totalPages; i++) {
      const pageItem = document.createElement('li');
      pageItem.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;
      pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
      paginationEl.appendChild(pageItem);
    }
    
    // Bouton Suivant
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage + 1}">Suivant</a>`;
    paginationEl.appendChild(nextItem);
    
    // Ajouter les gestionnaires d'événements pour les liens de pagination
    document.querySelectorAll('#empruntsPagination .page-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!this.parentElement.classList.contains('disabled')) {
          currentPage = parseInt(this.getAttribute('data-page'));
          loadEmpruntsData();
        }
      });
    });
  }
  
  // Fonction pour obtenir la classe de badge selon le statut
  function getBadgeClass(status) {
    switch(status) {
      case "Pas prêt": return "bg-warning text-dark";
      case "Prêt": return "bg-success";
      case "Parti": return "bg-primary";
      case "Revenu": return "bg-info text-dark";
      case "Inventorié": return "bg-secondary";
      default: return "bg-secondary";
    }
  }
  
  // Ouvrir le formulaire d'emprunt pour un nouvel emprunt
  function openEmpruntForm(empruntData = null) {
    // Réinitialiser le formulaire
    document.getElementById('empruntForm').reset();
    document.getElementById('empruntId').value = '';
    
    // Définir la date d'aujourd'hui comme date par défaut pour le départ
    const today = new Date();
    const todayFormatted = today.toISOString().split('T')[0]; // Format YYYY-MM-DD
    document.getElementById('empruntDateDepart').value = todayFormatted;
    
    // Définir une date par défaut pour le retour (aujourd'hui + 14 jours)
    const returnDate = new Date();
    returnDate.setDate(returnDate.getDate() + 14);
    const returnDateFormatted = returnDate.toISOString().split('T')[0];
    document.getElementById('empruntDateRetour').value = returnDateFormatted;
    
    if (empruntData) {
      // Mode édition - préremplir le formulaire avec les données existantes
      document.getElementById('empruntModalLabel').textContent = 'Modifier un emprunt';
      document.getElementById('empruntId').value = empruntData.ID;
      document.getElementById('empruntNom').value = empruntData["Nom Manipulation"] || '';
      document.getElementById('empruntLieu').value = empruntData.Lieu || '';
      
      // Conversion des dates du format JJ/MM/AAAA au format YYYY-MM-DD
      if (empruntData["Date départ"] && empruntData["Date départ"].includes('/')) {
        const parts = empruntData["Date départ"].split('/');
        document.getElementById('empruntDateDepart').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      
      if (empruntData["Date retour"] && empruntData["Date retour"].includes('/')) {
        const parts = empruntData["Date retour"].split('/');
        document.getElementById('empruntDateRetour').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      
      document.getElementById('empruntSecteur').value = empruntData.Secteur || '';
      document.getElementById('empruntReferent').value = empruntData.Référent || '';
      document.getElementById('empruntEmprunteur').value = empruntData.Emprunteur || '';
      document.getElementById('empruntNotes').value = empruntData.Notes || '';
      
    } else {
      // Mode création
      document.getElementById('empruntModalLabel').textContent = 'Nouvel emprunt';
    }
    
    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('empruntModal'));
    modal.show();
  }
  
  // Éditer un emprunt existant
  function editEmprunt(empruntId) {
    showSpinner();
    
    google.script.run
      .withSuccessHandler(function(empruntData) {
        hideSpinner();
        if (empruntData) {
          openEmpruntForm(empruntData);
        } else {
          showErrorMessage('Emprunt non trouvé');
        }
      })
      .withFailureHandler(function(error) {
        console.error('Erreur lors de la récupération des données de l\'emprunt:', error);
        hideSpinner();
        showErrorMessage('Erreur lors de la récupération des données de l\'emprunt: ' + error);
      })
      .getEmpruntById(empruntId);
  }
  
  // Visualiser un emprunt (pour l'instant, juste un message)
  function viewEmprunt(empruntId) {
    // Pour l'instant, on affiche juste un message
    alert(`Visualisation de l'emprunt ${empruntId} - Fonctionnalité à venir`);
  }
  
  // Sauvegarder les données du formulaire d'emprunt
  function saveEmpruntForm() {
    // Valider le formulaire
    const form = document.getElementById('empruntForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    // Récupérer les données du formulaire
    const empruntData = {
      ID: document.getElementById('empruntId').value,
      "Nom Manipulation": document.getElementById('empruntNom').value,
      Lieu: document.getElementById('empruntLieu').value,
      "Date départ": document.getElementById('empruntDateDepart').value, // Format YYYY-MM-DD
      "Date retour": document.getElementById('empruntDateRetour').value, // Format YYYY-MM-DD
      Secteur: document.getElementById('empruntSecteur').value,
      Référent: document.getElementById('empruntReferent').value,
      Emprunteur: document.getElementById('empruntEmprunteur').value,
      Notes: document.getElementById('empruntNotes').value
    };
    
    // Afficher le spinner
    showSpinner();
    
    // Envoyer les données au serveur
    google.script.run
      .withSuccessHandler(function(result) {
        hideSpinner();
        
        if (result) {
          // Fermer le modal
          bootstrap.Modal.getInstance(document.getElementById('empruntModal')).hide();
          
          // Afficher un message de succès
          alert('Emprunt enregistré avec succès !');
          
          // Recharger la liste d'emprunts
          loadEmpruntsData();
        } else {
          alert('Erreur lors de l\'enregistrement de l\'emprunt.');
        }
      })
      .withFailureHandler(function(error) {
        hideSpinner();
        console.error('Erreur lors de l\'enregistrement de l\'emprunt:', error);
        alert('Erreur lors de l\'enregistrement de l\'emprunt: ' + error);
      })
      .saveEmpruntFromUI(empruntData);
  }
</script>
