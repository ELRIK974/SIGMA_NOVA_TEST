<div id="empruntsPage">
  <h1 class="mb-4">
    <i class="fas fa-exchange-alt me-2"></i>
    Gestion des emprunts
  </h1>
  
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-list me-2"></i> Liste des emprunts</span>
          <button type="button" class="btn btn-success btn-sm" id="btnNouvelEmprunt">
            <i class="fas fa-plus me-1"></i> Nouvel emprunt
          </button>
        </div>
        <div class="card-body">
          <table class="table table-striped table-hover" id="empruntsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nom Manipulation</th>
                <th>Dates (Départ - Retour)</th>
                <th>Statut</th>
                <th>Emprunteur</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Sera rempli dynamiquement -->
              <tr>
                <td colspan="6" class="text-center">Chargement des données...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmer la suppression</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer cet emprunt ?</p>
          <p class="text-danger"><strong>Cette action est irréversible.</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteEmprunt">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let empruntToDelete = null;

  // Fonction d'initialisation pour la page Emprunts
  function initializeEmpruntsPage() {
    console.log("Initialisation de la page Emprunts");
    
    // Charger les emprunts
    loadEmpruntsData();
    
    // Ajouter le gestionnaire d'événement pour le bouton de suppression
    document.getElementById('confirmDeleteEmprunt').addEventListener('click', function() {
      if (empruntToDelete) {
        deleteEmprunt(empruntToDelete);
      }
    });
    
    // Ajouter le gestionnaire d'événement pour le bouton Nouvel emprunt
    document.getElementById('btnNouvelEmprunt').addEventListener('click', function() {
      alert("La création d'emprunts sera implémentée dans la prochaine étape.");
    });
  }
  
  // Charger les données des emprunts
  function loadEmpruntsData() {
    showSpinner();
    
    google.script.run
      .withSuccessHandler(function(data) {
        hideSpinner();
        
        // Remplir le tableau avec les emprunts
        fillEmpruntsTable(data.emprunts);
      })
      .withFailureHandler(function(error) {
        hideSpinner();
        console.error("Erreur lors du chargement des emprunts:", error);
        showErrorMessage("Erreur lors du chargement des emprunts: " + error);
      })
      .getEmpruntsPageData(1, 10, 'Tous');
  }
  
  // Remplir le tableau des emprunts
  function fillEmpruntsTable(emprunts) {
    const tbody = document.querySelector('#empruntsTable tbody');
    tbody.innerHTML = '';
    
    if (!emprunts || emprunts.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="6" class="text-center">Aucun emprunt trouvé</td>';
      tbody.appendChild(row);
      return;
    }
    
    emprunts.forEach(emprunt => {
      const row = document.createElement('tr');
      
      // Ajouter une classe selon le statut
      if (emprunt.Statut === "Pas prêt") {
        row.classList.add('table-warning');
      } else if (emprunt.Statut === "Parti") {
        row.classList.add('table-info');
      } else if (emprunt.Statut === "Revenu") {
        row.classList.add('table-success');
      }
      
      row.innerHTML = `
        <td>${emprunt.ID || ''}</td>
        <td>${emprunt["Nom Manipulation"] || ''}</td>
        <td>${emprunt["Date départ"] || ''} - ${emprunt["Date retour"] || ''}</td>
        <td><span class="badge ${getStatusBadgeClass(emprunt.Statut)}">${emprunt.Statut || ''}</span></td>
        <td>${emprunt.Emprunteur || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1 btn-edit-emprunt" data-id="${emprunt.ID}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-delete-emprunt" data-id="${emprunt.ID}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Ajouter les gestionnaires d'événements pour les boutons d'action
    document.querySelectorAll('.btn-edit-emprunt').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        alert(`La modification d'emprunt sera implémentée dans la prochaine étape (ID: ${id}).`);
      });
    });
    
    document.querySelectorAll('.btn-delete-emprunt').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        confirmDeleteEmprunt(id);
      });
    });
  }
  
  // Obtenir la classe CSS pour le badge de statut
  function getStatusBadgeClass(status) {
    switch(status) {
      case 'Pas prêt': return 'bg-warning text-dark';
      case 'Prêt': return 'bg-primary';
      case 'Parti': return 'bg-info';
      case 'Revenu': return 'bg-success';
      case 'Inventorié': return 'bg-secondary';
      default: return 'bg-secondary';
    }
  }
  
  // Confirmer la suppression d'un emprunt
  function confirmDeleteEmprunt(id) {
    empruntToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
  }
  
  // Supprimer un emprunt
  function deleteEmprunt(id) {
    showSpinner();
    
    google.script.run
      .withSuccessHandler(function(success) {
        hideSpinner();
        
        // Fermer le modal de confirmation
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        
        // Réinitialiser l'ID de l'emprunt à supprimer
        empruntToDelete = null;
        
        if (success) {
          // Recharger les données
          loadEmpruntsData();
        } else {
          showErrorMessage("Erreur lors de la suppression de l'emprunt");
        }
      })
      .withFailureHandler(function(error) {
        hideSpinner();
        console.error("Erreur lors de la suppression de l'emprunt:", error);
        showErrorMessage("Erreur lors de la suppression de l'emprunt");
      })
      .deleteEmpruntFromUI(id);
  }
</script>
